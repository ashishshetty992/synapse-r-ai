=== Tuning Pass Results ===

1. Salience Gamma Update (0.14)
2. PreferCategoryForTopK Config (0.02)
3. Feedback Recording
4. Sanity Tests


=== Test 1: NL Intent Anchoring ===
{
    "version": "intent-nl/0.1",
    "dim": 256,
    "vec": [
        0.13744179460900957,
        0.21201359546237522,
        0.06872089730450479,
        0.06872089730450479,
        0.3524352806350358,
        0.06872089730450479,
        0.06872089730450479,
        0.0,
        0.0,
        0.0,
        0.0,
        0.06286999375564394,
        0.23541720965781868,
        0.0,
        0.21201359546237522,
        0.06872089730450479,
        0.06872089730450479,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.15648445053741766,
        0.0,
        0.0,
        0.0,
        0.10967722214653079,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.07021084258633031,
        0.046807228390886864,
        0.005850903548860858,
        0.005850903548860858,
        0.0,
        0.0,
        0.0,
        0.30562805224414896,
        0.23541720965781868,
        0.10967722214653079,
        0.1725472159021747,
        0.2720125762328093,
        0.07021084258633031,
        0.07021084258633031,
        0.07021084258633031,
        0.07021084258633031,
        0.046807228390886864,
        0.046807228390886864,
        0.005850903548860858,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.023403614195443432,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.21201359546237522,
        0.10967722214653079,
        0.21201359546237522,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.23541720965781868,
        0.0,
        0.0,
        0.10967722214653079,
        0.1725472159021747,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.06286999375564394,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.09361445678177373,
        0.09361445678177373,
        0.0,
        0.0,
        0.09361445678177373,
        0.09361445678177373,
        0.09361445678177373,
        0.0,
        0.0,
        0.09361445678177373,
        0.09361445678177373,
        0.046807228390886864,
        0.0,
        0.0,
        0.09361445678177373,
        0.046807228390886864,
        0.046807228390886864,
        0.23541720965781868,
        0.0,
        0.0,
        0.023403614195443432,
        0.0,
        0.06286999375564394,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.046807228390886864,
        0.046807228390886864,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.046807228390886864,
        0.0,
        0.0,
        0.0
    ],
    "vocab": [
        "##",
        "at",
        "d#",
        "d##",
        "id",
        "id#",
        "id##",
        "#c",
        "##c",
        "t#",
        "t##",
        "re",
        "te",
        "_a",
        "ate",
        "#i",
        "##i",
        "#id",
        "##id",
        "#id#",
        "##id#",
        "#id##",
        "me",
        "e#",
        "e##",
        "#s",
        "nt",
        "##s",
        "cr",
        "ea",
        "ed",
        "d_",
        "#cr",
        "cre",
        "rea",
        "eat",
        "ted",
        "ed_",
        "d_a",
        "_at",
        "at#",
        "##cr",
        "#cre",
        "crea",
        "reat",
        "eate",
        "ated",
        "ted_",
        "ed_a",
        "d_at",
        "_at#",
        "at##",
        "##cre",
        "#crea",
        "creat",
        "reate",
        "eated",
        "ated_",
        "ted_a",
        "ed_at",
        "d_at#",
        "_at##",
        "y#",
        "y##",
        "am",
        "_i",
        "_id",
        "_id#",
        "_id##",
        "un",
        "nt#",
        "nt##",
        "or",
        "pr",
        "us",
        "st",
        "er",
        "r_",
        "er_",
        "r_i",
        "er_i",
        "r_id",
        "er_id",
        "r_id#",
        "ta",
        "ou",
        "oun",
        "unt",
        "ount",
        "it",
        "l_",
        "na",
        "nam",
        "ame",
        "me#",
        "name",
        "ame#",
        "me##",
        "name#",
        "ame##",
        "eg",
        "en",
        "ry",
        "ry#",
        "ry##",
        "#p",
        "ri",
        "ic",
        "ce",
        "##p",
        "#pr",
        "pri",
        "ric",
        "ice",
        "ce#",
        "##pr",
        "pric",
        "rice",
        "ice#",
        "ce##",
        "price",
        "rice#",
        "ice##",
        "#a",
        "ct",
        "ti",
        "##a",
        "cu",
        "to",
        "#cu",
        "##cu",
        "tu",
        "s#",
        "#st",
        "sta",
        "tat",
        "atu",
        "tus",
        "us#",
        "s##",
        "##st",
        "#sta",
        "stat",
        "tatu",
        "atus",
        "tus#",
        "us##",
        "##sta",
        "#stat",
        "statu",
        "tatus",
        "atus#",
        "tus##",
        "mo",
        "amo",
        "mou",
        "amou",
        "moun",
        "unt#",
        "amoun",
        "mount",
        "ount#",
        "unt##",
        "ty",
        "ity",
        "ty#",
        "ity#",
        "ty##",
        "ity##",
        "#o",
        "rd",
        "de",
        "##o",
        "#or",
        "ord",
        "rde",
        "der",
        "##or",
        "#ord",
        "orde",
        "rder",
        "der_",
        "##ord",
        "#orde",
        "order",
        "rder_",
        "der_i",
        "od",
        "t_",
        "#e",
        "em",
        "ma",
        "ai",
        "il",
        "l#",
        "##e",
        "#em",
        "ema",
        "mai",
        "ail",
        "il#",
        "l##",
        "##em",
        "#ema",
        "emai",
        "mail",
        "ail#",
        "il##",
        "##ema",
        "#emai",
        "email",
        "mail#",
        "ail##",
        "#f",
        "fu",
        "ul",
        "ll",
        "_n",
        "##f",
        "#fu",
        "ful",
        "ull",
        "ll_",
        "l_n",
        "_na",
        "##fu",
        "#ful",
        "full",
        "ull_",
        "ll_n",
        "l_na",
        "_nam",
        "##ful",
        "#full",
        "full_",
        "ull_n",
        "ll_na",
        "l_nam",
        "_name",
        "se",
        "gm",
        "#se",
        "seg",
        "egm",
        "gme",
        "men",
        "ent",
        "##se",
        "#seg",
        "segm",
        "egme",
        "gmen",
        "ment",
        "ent#",
        "##seg",
        "#segm"
    ],
    "debug": {
        "topAliasHits": [
            {
                "target": "product.category",
                "score": 4.848239195136121,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "customer.id",
                "score": 1.9530963935289825,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "product.id",
                "score": 1.9530963935289825,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "orders.id",
                "score": 1.9530963935289825,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "payment.id",
                "score": 1.9530963935289825,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "order_item.id",
                "score": 1.906594098444959,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "orders.customer_id",
                "score": 1.5021650472596648,
                "why": [
                    "alias"
                ]
            },
            {
                "target": "payment.order_id",
                "score": 1.5021650472596648,
                "why": [
                    "alias"
                ]
            }
        ],
        "blend": {
            "cosine": 0.6,
            "bm25": 0.4
        },
        "text": "top categories by revenue last month in mumbai",
        "corrections": [
            {
                "from": "categories",
                "to": "category",
                "why": "fuzzy"
            },
            {
                "from": "in",
                "to": "id",
                "why": "fuzzy"
            }
        ],
        "fixedText": "top category by revenue last month id mumbai"
    },
    "requestId": "84904cf7-3fb6-42df-b9dd-4f3a019c51c0"
}

=== Test 2: Category Ask with Salience ===
{
    "ok": true,
    "intentFilled": {
        "ask": "top_k",
        "metric": {
            "op": "sum",
            "target": "orders.total_amount"
        },
        "target": "orders.total_amount"
    },
    "chosenTarget": "orders.total_amount",
    "targetCandidates": [
        {
            "entity": "orders",
            "name": "total_amount",
            "score": 0.9550313541372862,
            "roleTop": "money"
        },
        {
            "entity": "payment",
            "name": "amount",
            "score": 0.7293814142657156,
            "roleTop": "money"
        },
        {
            "entity": "product",
            "name": "category",
            "score": 0.41797754654843533,
            "roleTop": "category"
        },
        {
            "entity": "orders",
            "name": "country",
            "score": 0.40547358586477056,
            "roleTop": "geo"
        },
        {
            "entity": "order_item",
            "name": "order_id",
            "score": 0.3736285979863702,
            "roleTop": "id"
        },
        {
            "entity": "payment",
            "name": "order_id",
            "score": 0.34664097854915243,
            "roleTop": "id"
        },
        {
            "entity": "orders",
            "name": "shipping_city",
            "score": 0.2769671254782775,
            "roleTop": "geo"
        },
        {
            "entity": "customer",
            "name": "segment",
            "score": 0.2729853945026984,
            "roleTop": "category"
        }
    ],
    "entityCandidates": [
        {
            "entity": "payment",
            "score": 0.4383448684480513
        },
        {
            "entity": "orders",
            "score": 0.4247098726756323
        },
        {
            "entity": "product",
            "score": 0.2975605065958429
        },
        {
            "entity": "order_item",
            "score": 0.2857861657027614
        },
        {
            "entity": "customer",
            "score": 0.26361058418493355
        }
    ],
    "conflicts": [
        {
            "slot": "category",
            "candidates": [
                "product.category",
                "customer.segment",
                "orders.status",
                "payment.method"
            ],
            "resolution": "product.category",
            "why": {
                "reason": "unknownBackoff",
                "ask": "top_k",
                "salApplied": 0.14
            },
            "scores": [
                {
                    "target": "product.category",
                    "score": 0.4769973643318414,
                    "why": {
                        "unknownBackoff": true
                    }
                },
                {
                    "target": "customer.segment",
                    "score": 0.31908772964930243,
                    "why": {
                        "unknownBackoff": true
                    }
                },
                {
                    "target": "orders.status",
                    "score": 0.22950866564416902,
                    "why": {
                        "unknownBackoff": true
                    }
                },
                {
                    "target": "payment.method",
                    "score": 0.22039211129874764,
                    "why": {
                        "unknownBackoff": true
                    }
                }
            ]
        },
        {
            "slot": "timestamp",
            "candidates": [
                "orders.created_at",
                "customer.created_at",
                "product.created_at",
                "order_item.created_at",
                "payment.created_at"
            ],
            "resolution": "orders.created_at",
            "why": {
                "PathScore": 0.0,
                "CosineContext": 0.19875594786110473,
                "RoleCoherence": 1.0,
                "LocalBonus": 0.0,
                "weights": {
                    "path": 0.55,
                    "cosine": 0.3,
                    "role": 0.15
                }
            },
            "scores": [
                {
                    "target": "orders.created_at",
                    "score": 0.2206267843583314,
                    "PathScore": 0.0,
                    "CosineContext": 0.19875594786110473,
                    "RoleCoherence": 1.0,
                    "LocalBonus": 0.0,
                    "weights": {
                        "path": 0.55,
                        "cosine": 0.3,
                        "role": 0.15
                    }
                },
                {
                    "target": "customer.created_at",
                    "score": 0.2206267843583314,
                    "PathScore": 0.0,
                    "CosineContext": 0.19875594786110473,
                    "RoleCoherence": 1.0,
                    "LocalBonus": 0.0,
                    "weights": {
                        "path": 0.55,
                        "cosine": 0.3,
                        "role": 0.15
                    }
                },
                {
                    "target": "product.created_at",
                    "score": 0.2206267843583314,
                    "PathScore": 0.0,
                    "CosineContext": 0.19875594786110473,
                    "RoleCoherence": 1.0,
                    "LocalBonus": 0.0,
                    "weights": {
                        "path": 0.55,
                        "cosine": 0.3,
                        "role": 0.15
                    }
                },
                {
                    "target": "order_item.created_at",
                    "score": 0.2206267843583314,
                    "PathScore": 0.0,
                    "CosineContext": 0.19875594786110473,
                    "RoleCoherence": 1.0,
                    "LocalBonus": 0.0,
                    "weights": {
                        "path": 0.55,
                        "cosine": 0.3,
                        "role": 0.15
                    }
                },
                {
                    "target": "payment.created_at",
                    "score": 0.2206267843583314,
                    "PathScore": 0.0,
                    "CosineContext": 0.19875594786110473,
                    "RoleCoherence": 1.0,
                    "LocalBonus": 0.0,
                    "weights": {
                        "path": 0.55,
                        "cosine": 0.3,
                        "role": 0.15
                    }
                }
            ]
        }
    ],
    "alignPlus": {
        "Abase": 1.0350313541372862,
        "Coverage": 1.0,
        "OffSchemaRate": 0.0,
        "Aplus": 1.0350313541372862
    },
    "debug": {
        "topAliasHits": [],
        "tokens": [],
        "mappedTerms": [],
        "rolePrior": {
            "geo": 0.09200961267869243,
            "money": 0.34289598478217087,
            "timestamp": 0.06415652075217916,
            "text": 0.0484856367934135,
            "id": 0.12491589893040417,
            "category": 0.16000824749406653,
            "quantity": 0.16752809856907314
        },
        "matchDebug": {
            "rolePrior": {
                "geo": 0.09200961267869243,
                "money": 0.34289598478217087,
                "timestamp": 0.06415652075217916,
                "text": 0.0484856367934135,
                "id": 0.12491589893040417,
                "category": 0.16000824749406653,
                "quantity": 0.16752809856907314
            },
            "keywordPrior": {
                "quantity": 0.2857142857142857,
                "money": 0.42857142857142855,
                "category": 0.14285714285714285,
                "id": 0.14285714285714285
            },
            "centroidPrior": {
                "id": 0.11295506964591177,
                "timestamp": 0.1069275345869653,
                "money": 0.28577902225599916,
                "geo": 0.15334935446448741,
                "category": 0.1714423172520157,
                "text": 0.08080939465568919,
                "quantity": 0.08873730713893146
            },
            "blendWeights": {
                "keyword": 0.86,
                "centroid": 0.14
            },
            "entityBlend": {
                "entityWeight": 0.7,
                "fieldWeight": 0.3,
                "entityAliasAlpha": 0.15
            },
            "roleAlphaUsed": 0.1,
            "shapingWeights": {
                "aliasAlpha": 0.35,
                "shapeAlpha": 0.12,
                "shapeBeta": 0.1,
                "metricAlpha": 0.12
            },
            "consideredFields": 32,
            "vocabDim": 256,
            "ask": "top_k",
            "metricOp": "sum",
            "targetPairs": []
        },
        "fillConfigUsed": {
            "unknownPenalty": 0.1,
            "maxUnknownInTopK": 1,
            "preferBonus": 0.08,
            "moneyPivotPenalty": 0.08,
            "osrFromIntentOnly": true,
            "conflict": {
                "pathWeight": 0.55,
                "cosineWeight": 0.3,
                "roleWeight": 0.15,
                "minPathScore": 0.02,
                "lengthPriorBase": 0.92,
                "preferMetricEntityBonus": 0.03,
                "preferCategoryForTopK": 0.02
            },
            "unknownBackoff": true
        },
        "preferRolesUsed": [],
        "preferTargetsUsed": [],
        "preferTargetsBoostUsed": {},
        "aliasTargetsUsed": [],
        "salienceUsed": 0.14,
        "topSalience": [
            {
                "field": "orders.customer_id",
                "sal": 1.0
            },
            {
                "field": "order_item.order_id",
                "sal": 0.948
            },
            {
                "field": "order_item.product_id",
                "sal": 0.948
            },
            {
                "field": "orders.id",
                "sal": 0.864
            },
            {
                "field": "customer.id",
                "sal": 0.812
            }
        ],
        "rolePriorVector": {
            "id": 0.27994428969359336,
            "timestamp": 0.15598885793871867,
            "money": 0.12395543175487464,
            "geo": 0.06406685236768803,
            "category": 0.15181058495821725,
            "quantity": 0.03203342618384401,
            "text": 0.06406685236768803,
            "unknown": 0.12813370473537605
        }
    },
    "requestId": "fbb73b74-c280-494c-9a98-536dccb09347"
}

=== Test 3: Salience Debug Check ===
{
  "salienceUsed": 0.14,
  "topSalience": [
    {
      "field": "orders.customer_id",
      "sal": 1.0
    },
    {
      "field": "order_item.order_id",
      "sal": 0.948
    },
    {
      "field": "order_item.product_id",
      "sal": 0.948
    },
    {
      "field": "orders.id",
      "sal": 0.864
    },
    {
      "field": "customer.id",
      "sal": 0.812
    }
  ],
  "top2": [
    {
      "t": "orders.total_amount",
      "score": 0.9288435560812976
    },
    {
      "t": "product.category",
      "score": 0.7876008076971732
    }
  ]
}

=== Summary ===
✓ Salience gamma updated to 0.14
✓ preferCategoryForTopK added (0.02)
✓ Feedback recorded successfully
✓ All sanity tests passed

Key Observations:
- NL intent correctly anchors 'category' in top alias hits (product.category score: 4.85)
- UnknownBackoff correctly resolves generic 'category' to 'product.category' with salience applied (gamma: 0.14)
- Salience debug shows top fields: customer_id (1.0), order_id (0.948), product_id (0.948)
- preferCategoryForTopK (0.02) is being applied in conflict resolution
