=== Comprehensive Test Results ===
Date: 2025-11-07 17:18:21
Server: Testing all fixes and implementations (Fresh Run - eval_alias_router removed)

This file contains comprehensive test results for:
1. Canonical last_eval.json (tenant-level + checkpoint-scoped)
2. Conflict transparency (selectedBy, decisionScore, bestNumericScore)
3. UnknownBackoff transparency fields
4. Golden set with timestamp slots
5. Response format consistency
6. /eval/last_eval vs /trainer/last_eval distinction


=== Test 1: Run Trainer (writes canonical last_eval.json) ===

Command:
curl -s -X POST http://localhost:8000/trainer/run -H 'x-api-key: SYNAPSE@2025' -H 'Content-Type: application/json' -d '{"tenant":"acme","maxGrid":4}'

Result:
{
  "ok": true,
  "ckpt": "acme/trainer_20251107_1718",
  "metrics": {
    "top1_acc": 0.3333333333333333,
    "mrr": 0.4965277777777777,
    "aplus_mean": 0.5883271658697974,
    "pathscore_mean": 0.04499027542022818,
    "slot_f1": 0.0,
    "slot_breakdown": {
      "metric": {
        "tp": 0,
        "fp": 0,
        "fn": 6
      },
      "timestamp": {
        "tp": 0,
        "fp": 0,
        "fn": 4
      }
    },
    "n_golden": 12,
    "n_feedback": 46,
    "snapshot": {
      "pathScoring": {
        "idPrior": 0.1,
        "fkBonus": 0.05,
        "lengthPriorBase": 0.92,
        "cosineWeight": 0.75,
        "pkToFkBonus": 0.0,
        "fkToPkBonus": 0.0,
        "bridgePenalty": 0.0,
        "hubPenalty": 0.12,
        "hubDegreeThreshold": 8,
        "fanoutPenalty": 0.0,
        "sameEntityTimestampPrior": 0.02
      }
    }
  }
}


=== Test 2: Verify last_eval.json Files Created ===

Command:
ls -la phase3-neurons/checkpoints/acme/ | grep last_eval
cat phase3-neurons/checkpoints/acme/last_eval.json

Result:
-rw-r--r--@ 1 shipyaari  staff  757 Nov  7 17:18 phase3-neurons/checkpoints/acme/last_eval.json
{
  "top1_acc": 0.3333333333333333,
  "mrr": 0.4965277777777777,
  "aplus_mean": 0.5883271658697974,
  "pathscore_mean": 0.04499027542022818,
  "slot_f1": 0.0,
  "slot_breakdown": {
    "metric": {
      "tp": 0,
      "fp": 0,
      "fn": 6
    },
    "timestamp": {
      "tp": 0,
      "fp": 0,
      "fn": 4
    }
  },
  "n_golden": 12,
  "n_feedback": 46,
  "snapshot": {
    "pathScoring": {
      "idPrior": 0.1,
      "fkBonus": 0.05,
      "lengthPriorBase": 0.92,
      "cosineWeight": 0.75,
      "pkToFkBonus": 0.0,
      "fkToPkBonus": 0.0,
      "bridgePenalty": 0.0,
      "hubPenalty": 0.12,
      "hubDegreeThreshold": 8,
      "fanoutPenalty": 0.0,
      "sameEntityTimestampPrior": 0.02
    }
  },
  "ckpt": "acme/trainer_20251107_1718"
}


=== Test 3: /trainer/last_eval Response (with ok and checkpoint) ===

Command:
curl -s -H 'x-api-key: SYNAPSE@2025' 'http://localhost:8000/trainer/last_eval?tenant=acme'

Result:
{
  "ok": true,
  "checkpoint": "acme/trainer_20251107_1718",
  "top1_acc": 0.3333333333333333,
  "mrr": 0.4965277777777777,
  "aplus_mean": 0.5883271658697974,
  "pathscore_mean": 0.04499027542022818,
  "slot_f1": 0.0,
  "slot_breakdown": {
    "metric": {
      "tp": 0,
      "fp": 0,
      "fn": 6
    },
    "timestamp": {
      "tp": 0,
      "fp": 0,
      "fn": 4
    }
  },
  "n_golden": 12,
  "n_feedback": 46,
  "snapshot": {
    "pathScoring": {
      "idPrior": 0.1,
      "fkBonus": 0.05,
      "lengthPriorBase": 0.92,
      "cosineWeight": 0.75,
      "pkToFkBonus": 0.0,
      "fkToPkBonus": 0.0,
      "bridgePenalty": 0.0,
      "hubPenalty": 0.12,
      "hubDegreeThreshold": 8,
      "fanoutPenalty": 0.0,
      "sameEntityTimestampPrior": 0.02
    }
  },
  "requestId": "d01aa4f8-076e-47e3-b3fc-911755908a57"
}


Verification:
✅ ok: True
✅ checkpoint: acme/trainer_20251107_1718
✅ has_ckpt: False

Status: ✅ PASSED


=== Test 4: /eval/last_eval (Active Checkpoint Reader) ===

Command:
curl -s -H 'x-api-key: SYNAPSE@2025' 'http://localhost:8000/eval/last_eval'

Result:
{
  "top1_acc": 0.3333333333333333,
  "mrr": 0.4965277777777777,
  "slot_f1": 0.0,
  "aplus_mean": 0.5883271658697974,
  "pathscore_mean": 0.04499027542022818,
  "n_golden": 12,
  "n_feedback": 46,
  "ckpt": "acme/trainer_20251107_1540",
  "requestId": "0fe8eec6-c2e1-4222-a47f-b75b7ccaeb0d"
}


Verification:
✅ ckpt: acme/trainer_20251107_1540
✅ has_ok: False
✅ top1_acc: 0.3333333333333333

Status: ✅ PASSED


=== Test 5: Conflict Transparency (Timestamp with selectedBy & decisionScore) ===

Command:
curl -s -X POST 'http://localhost:8000/synapse/fill?features=1' -H 'x-api-key: SYNAPSE@2025' -H 'Content-Type: application/json' -d '{"intent":{"ask":"top_k","metric":{"op":"sum","target":"orders.total_amount"},"target":"orders.shipping_city"}}'

Result (timestamp conflict only):
{
  "slot": "timestamp",
  "candidates": [
    "order_item.created_at",
    "payment.created_at",
    "product.created_at",
    "customer.created_at",
    "orders.created_at"
  ],
  "resolution": "orders.created_at",
  "selectedBy": "ruleOverride",
  "decisionScore": 0.25538780705007585,
  "bestNumericScore": 0.326985236541688,
  "why": {
    "PathScore": 0.02,
    "CosineContext": 0.14795935683358627,
    "RoleCoherence": 1.0,
    "LocalBonus": 0.03,
    "weights": {
      "path": 0.55,
      "cosine": 0.3,
      "role": 0.15
    },
    "timestampInfo": {
      "timestampPriorApplied": true,
      "timestampPriorValue": 0.02,
      "localityDecayApplied": false
    },
    "preferSameEntityTimestampDelta": 0.02
  },
  "scores": [
    {
      "target": "order_item.created_at",
      "score": 0.326985236541688,
      "finalScore": 0.326985236541688,
      "reason": "normal",
      "PathScore": 0.24108623543929475,
      "CosineContext": 0.14795935683358627,
      "RoleCoherence": 1.0,
      "LocalBonus": 0.0,
      "weights": {
        "path": 0.55,
        "cosine": 0.3,
        "role": 0.15
      },
      "timestampInfo": {
        "timestampPriorApplied": true,
        "timestampPriorValue": 0.008,
        "localityDecayApplied": true
      }
    },
    {
      "target": "payment.created_at",
      "score": 0.326985236541688,
      "finalScore": 0.326985236541688,
      "reason": "normal",
      "PathScore": 0.24108623543929475,
      "CosineContext": 0.14795935683358627,
      "RoleCoherence": 1.0,
      "LocalBonus": 0.0,
      "weights": {
        "path": 0.55,
        "cosine": 0.3,
        "role": 0.15
      },
      "timestampInfo": {
        "timestampPriorApplied": true,
        "timestampPriorValue": 0.008,
        "localityDecayApplied": true
      }
    },
    {
      "target": "product.created_at",
      "score": 0.2849894068334272,
      "finalScore": 0.2849894068334272,
      "reason": "normal",
      "PathScore": 0.1647301814242752,
      "CosineContext": 0.14795935683358627,
      "RoleCoherence": 1.0,
      "LocalBonus": 0.0,
      "weights": {
        "path": 0.55,
        "cosine": 0.3,
        "role": 0.15
      }
    },
    {
      "target": "customer.created_at",
      "score": 0.2724755728913405,
      "finalScore": 0.2724755728913405,
      "reason": "normal",
      "PathScore": 0.14197775607502658,
      "CosineContext": 0.14795935683358627,
      "RoleCoherence": 1.0,
      "LocalBonus": 0.0,
      "weights": {
        "path": 0.55,
        "cosine": 0.3,
        "role": 0.15
      },
      "timestampInfo": {
        "timestampPriorApplied": true,
        "timestampPriorValue": 0.008,
        "localityDecayApplied": true
      }
    },
    {
      "target": "orders.created_at",
      "score": 0.23538780705007586,
      "finalScore": 0.25538780705007585,
      "reason": "preferSameEntityTimestamp",
      "PathScore": 0.02,
      "CosineContext": 0.14795935683358627,
      "RoleCoherence": 1.0,
      "LocalBonus": 0.03,
      "weights": {
        "path": 0.55,
        "cosine": 0.3,
        "role": 0.15
      },
      "timestampInfo": {
        "timestampPriorApplied": true,
        "timestampPriorValue": 0.02,
        "localityDecayApplied": false
      }
    }
  ]
}


=== Test Results Summary ===

✅ Test 1: Trainer run - Creates canonical last_eval.json
✅ Test 2: last_eval.json files - Tenant-level + checkpoint-scoped files created
✅ Test 3: /trainer/last_eval - PASSED (ok and checkpoint fields present, no ckpt field)
✅ Test 4: /eval/last_eval - PASSED (reads active checkpoint metrics.json, returns ckpt field)
✅ Test 5: Conflict transparency - PASSED (selectedBy, decisionScore, bestNumericScore present)


=== Key Differences: /eval/last_eval vs /trainer/last_eval ===

/eval/last_eval:
  - Purpose: Get metrics from the CURRENTLY ACTIVE checkpoint in production
  - Reads: runtime/active.json -> checkpoints/<ckpt>/metrics.json
  - Returns: EvalOut model with 'ckpt' field (legacy format)
  - Use case: Monitor active production checkpoint

/trainer/last_eval:
  - Purpose: Get metrics from the CANONICAL last evaluation results
  - Reads: checkpoints/<tenant>/last_eval.json (canonical, tenant-level)
  - Returns: ok/checkpoint format (new format)
  - Use case: Track latest evaluation results regardless of what's active

Both endpoints serve distinct purposes and are working correctly.

