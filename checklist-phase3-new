Phase-3: AI/ML Neuron Layer + Planner Integration â€” Status Checklist (One-Liners)

0) Ground Truth & North Star
âœ… Clear goal: AI-assisted runtime (intent â†’ schema, safe UQL, MySQL+Mongo, indexes/parity/policy)
âœ… Success criteria defined (Exit Criteria & Metrics list)

â¸»

1) Neurons Service (FastAPI) & Contracts
âœ… FastAPI app skeleton: 27+ endpoints implemented across multiple routers (feedback, eval, trainer, fewshot, config, golden, principles)
âœ… Pydantic request/response models for all endpoints
âœ… External uem.json â†’ produces iem.json (dim configurable, default 256)
âœ… Runs locally (uvicorn, no Docker)
âœ… Happy-path validation; API key auth (x-api-key header); rate limiting (basic, RL_MAX/RL_WINDOW_SEC env vars); structured logs + decision log
âœ… Request ID propagation via middleware (x-request-id header in all responses)
âœ… Health check endpoint /healthz
âœ… Prometheus metrics endpoint /metrics
ðŸŸ¨ Robust validators (bad payloads, missing files) - need stricter Pydantic validators and range checks
ðŸŸ¨ Request-id propagation everywhere - most endpoints return requestId, verify all error responses include it

â¸»

2) Neuron-1: Schema Understanding (IEM)
âœ… Field embeddings (char-ngrams) + role priors (id/timestamp/money/geo/category/text/qty)
âœ… Alias generation (underscored â†” spaced variants)
âœ… Deterministic iem.json output (dim configurable, default 256)
âœ… Quality checks computed (ids cluster, amounts cluster) via cluster_quality function
âœ… IEM versioning/drift detection (compare iem.json vs iem.json.bak snapshots)
âœ… Entity-level embeddings (per-entity vectors computed)
âœ… POST /iem/build endpoint (builds IEM from UEM, saves to iem.json, computes salience/role prior)
âœ… GET /iem/verify endpoint (RoleBoost stats, drift alerts, cluster quality, warnings, salience preview, role prior vector)
âœ… GET /iem/show endpoint (shows IEM schema with entities, fields, roles, aliases)
âœ… F1 RoleBoostâ„¢: role-aware vector computation; emit roleBoost per field in /iem/verify
âœ… F2 AliasStabilityâ„¢: drift guard (feeds S(p)) - computed in /iem/verify via compute_alias_stability
âœ… Salience computation (entity centrality 45% + constraint weight 35% + glossary confidence 20%) - normalized 0..1
âœ… Role prior vector computation (default_role_prior_vector) - exposed in /iem/verify
ðŸŸ¨ Entity-level embeddings API endpoint (/iem/entities) - basic implementation exists but not exposed

â¸»

3) Neuron-2: Intent Encoder (NL + IQL)
âœ… Encoder v0.2 (IQL â†’ vector via char-ngrams bag)
âœ… POST /intent/encode endpoint (IQL â†’ vector, returns vec, vocab, version)
âœ… POST /intent/encode_nl endpoint (NL text â†’ vector with synonyms injection, time config, topAliasHits debug)
âœ… synonyms.json loading (e.g., "revenueâ†’total_amount", "cityâ†’shipping_city")
âœ… Time config integration (tenant-level time grammar via load_time_cfg)
âœ… Top alias hits debug output (shows matched aliases in debug.topAliasHits)
âœ… F6 SynoMixâ„¢ (BM25 alias score âŠ• cosine blend, alpha_cosine=0.6) - fully implemented in intent.py
âœ… BM25 scoring over IEM field aliases and synonyms
âœ… Synonym hit detection and mapping to target candidates
âœ… Cosine similarity vector blended with BM25-weighted vector
âœ… Blend weights exposed in debug output (cosine/BM25 ratio)
ðŸŸ¨ Few-shot aliases not merged into encode_nl runtime (loaded but not actively applied)
ðŸŸ¨ Few-shot hints not applied in matching runtime (loaded/displayed via /fewshot/show, not used in match_candidates)

â¸»

4) Neuron-3: Synapse Matching
âœ… Cosine ranking over IEM fields/entities (match_candidates function)
âœ… Tunables: topKFields, topKEntities, roleAlpha, aliasAlpha, shapeAlpha, shapeBeta, metricAlpha
âœ… Conflict resolver (multi "city"/"category" candidates) with blended scoring (PathScore, CosineContext, RoleCoherence)
âœ… POST /synapse/match endpoint (returns topFields, topEntities, debug with tenantId, pathScoring source, principles)
âœ… POST /synapse/fill endpoint (slot filling + conflict resolution + AlignPlus computation, returns intentFilled, chosenTarget, conflicts, alignPlus)
âœ… POST /synapse/paths endpoint (join path inference with PathScore, edge breakdowns, normalized scores, guardrails, LTR support)
âœ… POST /synapse/explain endpoint (explains slot filling decisions with per-candidate scores)
âœ… F3 AlignPlusâ„¢ (coverage-aware A(p)) - computed in synapse.py, values present in conflict why and scores (Abase, Coverage, OffSchemaRate, Aplus)
âœ… F4 PathScoreâ„¢ (semantics + index + fanout + hop cost) - implemented in synapse.py:_path_score with edge breakdowns
âœ… SalienceScore (gamma configurable, applied in matching via _apply_salience)
âœ… UnknownBackoff (resolves generic roles like 'category' to specific fields using salience)
âœ… Hub penalty toggle (hubPenalty, hubDegreeThreshold configurable in pathScoring)
âœ… Timestamp prior (same-entity + locality decay 0.4Ã— for 1-hop) - preferSameEntityTimestampDelta override live
âœ… Conflict transparency (selectedBy, decisionScore, bestNumericScore top-level; finalScore/reason per-candidate in scores[])
âœ… Canonical last_eval feed-through in debug (pathScoring source, principles enabled)
âœ… Per-edge breakdown in /synapse/paths debug (edgeScoresByPath with baseCos, basePrior, blend per edge)
âœ… Normalized scoreNorm 0â€“1 (scoreNormTop array for UI sliders, scoreNormHint)
âœ… Override guardrails with debug.warn when clamped (pathScoringOverrides clamped, warnings in debug.warn)
âœ… LTR (Learning to Rank) re-ranking for paths (x-ltr header, NEURONS_LTR_DEFAULT env, ltr_rerank_paths function)
âœ… Path features extraction (x-features header: hubSteps, fanoutSteps, bridges, pkToFkSteps, fkToPkSteps, revisits, uniqueEntities)
âœ… Path component breakdowns (avgCos, avgPrior, rawBlend, lengthPrior, final) in scoreComponentsByPath
âœ… Entity blend (entityWeight/fieldWeight/entityAliasAlpha, centroid_gamma) - configurable in entity.json
âœ… Salience scoring with gamma configurable (salience.gamma in shaping.json, applied in matching)
âœ… Shadow mode support (TRAINER_SHADOW_ONLY env, x-experiment: train-shadow header returns baseline vs active comparison)
ðŸŸ¨ Conflict transparency (finalScore/reason not top-level) - per-candidate only, not in top-level conflict object

â¸»

5) Neuron-4: Auto-Question Generator (PoC)
âœ… Prototype spec (top_k / trend / compare patterns)
âœ… POST /generate endpoint (produces IQLs per entity, writes to examples/aiql, generates coverage)
âœ… Validator (ops/validate-examples.js) passes all generated examples
âœ… Coverage emitted at examples/aiql/_coverage.json (per-entity role coverage)
âœ… GET /examples/coverage endpoint (returns cached coverage from last /generate call)
âœ… Make/NPM helpers: make generate-aiql, make validate-aiql, make regen-aiql, npm run regen:aiql
âœ… Strict mode (drops unsafe pivots by default, can disable with strict:false)

â¸»

6) Neuron-5: Learning & Few-Shot Tuning
âœ… Feedback store (append-only JSONL: data/feedback.jsonl with ts, tenant, intent, chosenTarget, otherSlots, iemHash, userAgent, latencyMs, rid)
âœ… POST /feedback/record endpoint (records feedback with PII filtering via sensitive flag)
âœ… Golden set management (curated eval in golden/ directory, supports list files)
âœ… GET /golden/list endpoint (returns all golden items for tenant)
âœ… POST /golden/add endpoint (adds golden item, tenant precedence: header â†’ query â†’ body â†’ default)
âœ… Trainer grid search (small-grid search over alias_alpha, shape_alpha, shape_beta, metric_alpha, role_alpha_default, salience.gamma)
âœ… POST /trainer/run endpoint (runs trainer, creates checkpoint, evaluates on golden set, returns metrics)
âœ… Metrics computation (Top-1 acc, MRR, Role hit@1, Slot F1, Aplus mean, PathScore mean, slot_breakdown)
âœ… Checkpoints (app/checkpoints/trainer_{yyyymmddHHMM}/shaping.json, fewshot.json, metrics.json)
âœ… Canonical last_eval.json (tenant-level: checkpoints/<tenant>/last_eval.json)
âœ… GET /trainer/last_eval endpoint (returns canonical last_eval.json, format: ok/checkpoint, no ckpt field)
âœ… GET /eval/last_eval endpoint (returns active checkpoint metrics.json, format: ckpt field, legacy format)
âœ… POST /trainer/activate endpoint (activates checkpoint, writes to runtime/active.json)
âœ… GET /trainer/versions endpoint (lists all checkpoints with metrics)
âœ… GET /fewshot/show endpoint (preview applied few-shot patterns, merges global â†’ tenant)
âœ… Versioning system (runtime/active.json with checkpoint, shaping, fewshot paths)
âœ… Prometheus metrics (synapse_trainer_runs_total, synapse_trainer_top1_acc{tenant}, synapse_trainer_mrr{tenant}, synapse_feedback_rows_total, synapse_golden_rows_total{tenant})
âœ… PII filtering (sensitive flag in feedback prevents storing raw user text)
âœ… Tenant isolation (checkpoints stored per tenant: checkpoints/<tenant>/...)
âœ… Weight clamps (safe ranges enforced: alias_alpha âˆˆ [0.25, 0.6], etc.)
âœ… Shadow AB testing structure (TRAINER_SHADOW_ONLY env var, x-experiment: train-shadow header)
âœ… Canary gating (TRAINER_TENANT_CANARY env var, tenant allowlist)
âœ… Slot metrics (Slot-F1 and slot_breakdown computed and exposed in trainer metrics)
âœ… Conflict transparency in trainer eval (all conflicts include selectedBy, decisionScore, bestNumericScore fields)
â›” POST /trainer/rollback endpoint (not implemented - should deactivate current checkpoint, optionally revert to previous)
â›” Make/NPM commands for trainer ops (make feedback-demo, make trainer-run, make trainer-activate CKPT=..., npm run train, npm run train:tenant, npm run trainer:activate)
ðŸŸ¨ Few-shot runtime integration (few-shot loaded and shown via /fewshot/show, but not actively used in encode_nl/match_candidates - needs wiring in intent.py and synapse.py)

â¸»

7) Schema Graph & Multi-Join Reasoning
âœ… Single-hop join path working (FK edges) and scored via PathScore
âœ… Multi-hop path finding (BFS up to 3 hops) - _bfs_paths function with caching (_BFS_CACHE)
âœ… In-memory graph building (_build_join_graph from IEM entities and joins)
âœ… PathScore ranking (all paths scored with PathScoreâ„¢, sorted by score)
âœ… Degree index computation (build_degree_index for hub detection)
âœ… Hub detection & penalties (hubDegreeThreshold, hubPenalty configurable)
âœ… Fanout penalties (fanoutPenalty per extra fanout step)
âœ… Bridge detection & penalties (bridgePenalty for narrow bottlenecks)
âœ… Direction-aware bonuses (pkToFkBonus for PKâ†’FK, fkToPkBonus for FKâ†’PK)
âœ… Edge breakdowns in paths (per-edge scoring components: baseCos, basePrior, blend, idPrior, fkBonus, dir bonuses, hub/fanout penalties)
âœ… Normalized scores (scoreNormTop 0..1 for UI consistency)
âœ… Guardrails (pathScoringOverrides clamped with warnings)
âœ… LTR re-ranking support (x-ltr header enables learning-to-rank reordering)
âœ… Path features (x-features header exposes hubSteps, fanoutSteps, bridges, pkToFkSteps, fkToPkSteps, revisits, uniqueEntities)
âœ… Path components (avgCos, avgPrior, rawBlend, lengthPrior, final) in scoreComponentsByPath
â›” Graph.json persistence (graph.json builder not implemented - should export entities + edges with FK=1.0, heuristic edges <1.0)
ðŸŸ¨ Path disambiguation using Aâº/C/S blend (paths scored but not disambiguated using full AlignPlus/CostPlus/Stability blend)

â¸»

8) Multi-GroupBy & Complex Query Shapes
âœ… Single & dual groupBy supported conceptually and in examples (segmentÃ—country, city over periods)
âœ… Examples validate against schema (ops/validate-examples.js passes)
ðŸŸ¨ Triple GROUP BY tests (MySQL list, Mongo composite _id) - examples exist conceptually but not in test suite
ðŸŸ¨ Compare periods Ã— extra dims (periodÃ—segmentÃ—country) - partial support, missing test cases
ðŸŸ¨ Nested AND/OR across joins - partial examples only, missing precedence tests
â›” Window functions (moving avg, YoY) - deferred to Phase-4
â›” F5 GroupInfoâ„¢ (parsimony vs informativeness) scoring - not yet computed (should compute InfoGain, parsimony penalty, informativeness reward)

â¸»

9) Integration with Phase-2 Runtime
âœ… E2E demonstrated (neuron targets â†’ UQL/SQL compilation on MySQL & Mongo)
âœ… x-intent-vec path works (can pass intent vector directly to planner)
âœ… Boltzmann exploration (Ï„) in beam selection (planner/src/index.ts:464 softmaxPick with tau)
ðŸŸ¨ Feature flag USE_NEURONS=1 toggle in runtime - structure exists, not fully plumbed end-to-end
ðŸŸ¨ Traces to include {A,C,P,S,R,Ï„} everywhere - partial (A/P/S computed, C/R/Ï„ missing or not propagated)
ðŸŸ¨ A(p)=AlignPlus computed in neurons, not fully surfaced in planner trace (computed but not in trace payload)
ðŸŸ¨ S(p)=AliasStability computed in /iem/verify, not used in planner (computed but not wired to planner scoring)
â›” C(p)=CostPlus (index/complexity hints) - not implemented (see Section 10)
â›” P(p)=GroupInfo (parsimony vs informativeness) - not implemented (see Section 8)
â›” R(p)=Parity/RBAC - not implemented (see Section 10)
â›” Fallback: low neuronScore â†’ rule planner - not implemented (should check threshold, fall back to rule-based planner)

â¸»

10) Parity, Index Safety & Policy
âœ… Parity endpoint working (minor ordering diffs acceptable)
âœ… Index guard (requireIndexedFilters=true) active in planner
ðŸŸ¨ Feed index/complexity hints into CostPlusâ„¢ scoring - index guard exists, hints not fed to scoring (adapters should emit hints: unindexed_range, join_depth, like_contains, non_sargable, est_rows)
â›” F8 CostPlusâ„¢ (unindexed_range, join_depth, like_contains, non_sargable, est_rows) - not implemented (should compute cost score based on adapter hints)
â›” F7 ParityTauâ„¢ (Kendall Ï„ from sampled parity) â†’ R(p) - not implemented (should sample parity results, compute Kendall's Ï„, use as penalty/reward)
â›” RBAC penalties into R(p) - not implemented (should check user permissions, apply penalties to restricted paths)

â¸»

11) Tests & Tooling
âœ… Phase-2 exerciser extended to call neurons
âœ… Example IQLs validate against schema (ops/validate-examples.js)
â›” run-phase3-tests.sh to orchestrate neurons endpoints (/iem/build, /iem/verify, /intent/encode, /intent/encode_nl, /synapse/match, /synapse/paths, /synapse/fill, /generate)
â›” Assertions for compiled UQL, traces with {A,C,P,S,R,Ï„}, multi-join & 3Ã— groupBy, parity Ï„_K present

â¸»

12) Documentation & Operability
âœ… Phase-3 test report (COMPREHENSIVE_TEST_RESULTS.txt exists)
âœ… Basic README.md (phase3-neurons/README.md with quick start, API endpoints, config)
ðŸŸ¨ README with wiring guide - basic README exists but missing detailed wiring guide (how to wire neurons into Phase-2 runtime, env vars, headers, trace payload structure, override guardrails, config hierarchy)
â›” Whitepaper appendix (A/C/P/S/R examples & weight sensitivity) - not implemented (should document formula definitions, weight sensitivity analysis, tuning guidelines, example calculations)

â¸»

13) Additional Endpoints & Features
âœ… GET /config/effective endpoint (runtime config viewer, shows active shaping/fewshot paths, synapseConfig with source)
âœ… GET /config/knobs endpoint (lightweight view of runtime-tunable knobs: pathScoring, alignPlus)
âœ… POST /config/knobs endpoint (update knobs at runtime with safe clamps, returns changed/now)
âœ… GET /debug/runtime endpoint (active checkpoint + synapse config, environment flags, activeCheckpoint ptr data)
âœ… GET /debug/graph endpoint (schema graph stats: degrees, top hubs, fanout summary with threshold)
âœ… GET /principles/show endpoint (shows merged principles.json from active checkpoint)
âœ… Active config merging (load_active_config_merged at startup, set_runtime_config)
âœ… Baseline config reset per request (_apply_baseline_cfg in middleware before each request)
âœ… Glossary support (for salience computation, loaded via load_glossary)
âœ… Time config support (tenant-level time grammar, loaded via load_time_cfg)
âœ… Decision logging (structured decision.jsonl with event tracking via log_decision)
âœ… Config hot-reload support (CFG_HOT env clears caches on each request)
âœ… Rate limiting with headers (x-ratelimit-limit, x-ratelimit-remaining, x-ratelimit-reset)
âœ… Path scoring override clamps (idPrior, fkBonus, cosineWeight, etc. clamped to safe ranges)
âœ… Body size limits (NEURONS_MAX_BODY env, default 2MB)
âœ… Trust proxy support (NEURONS_TRUST_PROXY env for x-forwarded-for)
âœ… Output base path restrictions (NEURONS_OUT_BASE env for file write safety)
âœ… Experiment headers: x-experiment (baseline-only, train-shadow modes supported)
âœ… Tenant canary support (TRAINER_TENANT_CANARY env var, tenant allowlist)
âœ… Shadow mode (TRAINER_SHADOW_ONLY env, x-experiment: train-shadow header)

â¸»

14) Neuron-6: Curiosity & Insight Engine
â›” Autonomous question generation & insight discovery - not started
â›” Schema-driven generators (discovers joins and measure/dimension pairs) - not started
â›” Anomaly generators (detects data drift, outliers, sudden metric variance) - not started
â›” Pattern generators (derives trends, deltas, ratios, seasonality, correlations) - not started
â›” Coverage explorer (identifies under-queried schemas) - not started
â›” Goal-oriented seeds (predefined probes: leakage, delay, inefficiency, fraud) - not started
â›” Utility scoring U(p) = f(A,C,P,S,R,Novelty,InfoGain) - not started
â›” Novelty computation (vector distance from past 7-day insights) - not started
â›” InfoGain computation (entropy / KL divergence over distributions) - not started
â›” /curiosity/feed endpoint (auto insights ranked by Utility) - not started
â›” /curiosity/feedback API (thumbs up/down or irrelevant) - not started
â›” Learning loop (feedback â†’ trainer) - not started
â›” Safety guardrails (cost, PII, parity) - not started

â¸»

Quick "What Matters Next" (Priorities)
1. Wire few-shot into runtime (encode_nl + match) â€” unlocks tenant-level adaptation (ðŸŸ¨â†’âœ…)
2. Planner scoring/trace with A/C/P/S/R â€” even stubbed C/P/R gives visibility now (ðŸŸ¨â†’âœ…)
3. Rollback + shadow â€” safety to experiment (â›”â†’âœ…)
4. Graph persistence + path disambiguation using Aâº/C/S â€” reduces brittle joins (ðŸŸ¨â†’âœ…)
5. Phase-3 runner & canary switches â€” reproducible eval + safe rollout (â›”/ðŸŸ¨â†’âœ…)
